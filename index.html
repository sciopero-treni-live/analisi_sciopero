<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andamento scioperi treni Nazionale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }

        .chart-label {
            min-width: 120px;
            font-weight: bold;
            color: #2c3e50;
        }

        .chart-track {
            flex: 1;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 0 15px;
            position: relative;
        }

        .chart-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease-in-out;
        }

        .chart-percentage {
            min-width: 50px;
            text-align: right;
            font-weight: bold;
            color: #2c3e50;
        }

        .impact-high { background: #e74c3c; }
        .impact-medium { background: #f39c12; }
        .impact-low { background: #27ae60; }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .last-update {
            background: #ecf0f1;
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #bdc3c7;
        }

        .strike-info {
            background: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .strike-info h2 {
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Aumentato min-width */
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: normal; /* Consente il wrapping del testo */
            word-break: break-word; /* Forze il break delle parole lunghe */
            line-height: 1.2; /* Riduci l'interlinea per pi√π spazio */
        }

        .content {
            padding: 30px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn.active,
        .filter-btn:hover {
            background: #3498db;
            color: white;
        }

        .trains-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .table-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            font-weight: bold;
            text-align: center;
        }

        .table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            padding: 15px 20px;
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.3s ease;
        }

        .table-row:hover {
            background: #f8f9fa;
        }

        .table-row.header {
            background: #34495e;
            color: white;
            font-weight: bold;
        }

        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
        }

        .status.partito {
            background: #27ae60;
            color: white;
        }

        .status.arrivato {
            background: #2980b9;
            color: white;
        }

        .status.soppresso {
            background: #e74c3c;
            color: white;
        }

        .status.parzialmente_soppresso {
            background: #f39c12;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 0.9em;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .table-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .filters {
                justify-content: center;
            }

            .top-cards {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÇ Andamento scioperi - Nazionale</h1>
            <div class="subtitle">Monitoraggio nazionale in tempo reale dei treni durante lo sciopero corrente</div>
        </div>

        <!-- Card affiancate per sciopero e impatto -->
        <div id="top-cards" class="top-cards" style="display: none; display: flex; gap: 20px; margin: 20px auto; padding: 0 20px;">
            <div id="strike-info" class="strike-card" style="flex: 1; background: #e74c3c; color: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                <h2 style="margin-bottom: 15px; font-size: 1.3em;">‚ö†Ô∏è Sciopero in Corso</h2>
                <div id="strike-details" style="font-size: 0.95em; line-height: 1.4;"></div>
            </div>
            <div id="impact-info" class="impact-card" style="flex: 1; background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3); display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div style="font-size: 1.6em; font-weight: bold;">
                    üìä Impatto: <span id="main-percentage-value">0%</span><br>
                    <small style="font-size: 0.7em; opacity: 0.9;">dei treni non garantiti</small>
                </div>
            </div>
        </div>

        <div class="last-update">
            <span>Ultimo aggiornamento: <span id="last-update">Caricamento...</span></span>
            <button class="refresh-btn" onclick="loadData()">üîÑ Aggiorna</button>
        </div>

        <div id="loading" class="loading">
            <h2>Caricamento dati...</h2>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-trains">0</div>
                    <div class="stat-label">Totale Treni</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="garantiti">0</div>
                    <div class="stat-label">Garantiti</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="effettuati">0</div>
                    <div class="stat-label">Effettuati (non garantiti)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="soppressi">0</div>
                    <div class="stat-label">Soppressi (non garantiti)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="parzialmente-soppressi">0</div>
                    <div class="stat-label">Parzialmente Soppressi (non garantiti)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="non-gestiti">0</div>
                    <div class="stat-label">Programmati ma scomparsi dai tabelloni</div>
                </div>
            </div>


            <div class="filters" style="display: none;">
                <button class="filter-btn active" onclick="filterTrains('all')">Tutti</button>
                <button class="filter-btn" onclick="filterTrains('garantiti')">Garantiti</button>
                <button class="filter-btn" onclick="filterTrains('soppressi')">Soppressi</button>
                <button class="filter-btn" onclick="filterTrains('parzialmente_soppressi')">Parzialmente Soppressi</button>
            </div>

            <div class="trains-table" style="display: none;">
                <div class="table-header">Situazione Treni in Tempo Reale</div>
                <div id="trains-body">
                    <!-- I dati saranno inseriti dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurazione
        const API_BASE = 'https://mansellrace.synology.me:10101';
        let trainsData = {};
        let currentFilter = 'all';
        let refreshInterval;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            // Auto-refresh ogni minuto (o intervallo specificato dall'API)
            setInterval(loadData, 60000);

            // Listener per ridimensionamento finestra
            window.addEventListener('resize', function() {
                // Se ci sono dati caricati, ricarica il grafico per adattarlo alla nuova dimensione
                if (trainsData && trainsData.metadata) {
                    displayDistributionChart(trainsData.metadata.statistics);
                }
            });
        });

        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('content').style.display = 'none';
                document.getElementById('error').style.display = 'none';

                const response = await fetch(`${API_BASE}/api/trains`);

                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }

                trainsData = await response.json();

                // Verifica se i dati sono validi
                if (!trainsData || !trainsData.metadata) {
                    throw new Error('Dati ricevuti non validi');
                }

                displayData(trainsData);

            } catch (error) {
                console.error('Errore nel caricamento dati:', error);

                // Mostra errore solo se √® un vero errore di connessione
                if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('HTTPS')) {
                    document.getElementById('error').textContent =
                        'Errore di connessione. Verifica che l\'API sia in funzione.';
                    document.getElementById('error').style.display = 'block';
                } else {
                    // Se l'API funziona ma i dati sono vuoti, mostra comunque la pagina
                    console.log('API funziona ma dati vuoti, mostro pagina con valori 0');
                    displayData(trainsData || { metadata: { statistics: { total_trains: 0, by_category: {} }, strike_info: { descrizione: 'Nessuno sciopero programmato' } }, trains: {} });
                }

                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayData(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // Aggiorna timestamp
            if (data.metadata.last_updated) {
                const lastUpdate = new Date(data.metadata.last_updated);
                if (!isNaN(lastUpdate.getTime())) {
                    document.getElementById('last-update').textContent =
                        lastUpdate.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                } else {
                    document.getElementById('last-update').textContent = 'Data non valida';
                }
            } else {
                document.getElementById('last-update').textContent = 'Mai aggiornato';
            }

            // Info sciopero
            displayStrikeInfo(data.metadata.strike_info);

            // Statistiche
            displayStatistics(data);

            // Tabella treni (nascosta nella versione nazionale)
            // displayTrainsTable(data.trains);

            // Imposta intervallo di refresh dall'API
            if (data.metadata.refresh_interval) {
                clearInterval(refreshInterval);
                refreshInterval = setInterval(loadData,
                    data.metadata.refresh_interval * 1000);
            }
        }

        function displayStrikeInfo(strikeInfo) {
            const strikeDiv = document.getElementById('strike-info');
            const strikeDetails = document.getElementById('strike-details');
            const strikeCard = strikeDiv.closest('.strike-card'); // Ottieni la card esterna
            const strikeTitle = strikeCard.querySelector('h2'); // Ottieni il titolo

            const now = new Date();
            const inizio = strikeInfo.inizio ? new Date(strikeInfo.inizio) : null;
            const fine = strikeInfo.fine ? new Date(strikeInfo.fine) : null;

            let statusText = '';
            let statusColor = '';
            let statusIcon = '';
            let periodoText = 'Non specificato';

            // Formatta date in italiano
            const formatTime = (date) => date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            const formatDate = (date) => date.toLocaleDateString('it-IT', { day: 'numeric', month: 'numeric' });

            if (inizio && fine) {
                const giornoInizio = inizio.toDateString();
                const giornoFine = fine.toDateString();

                if (giornoInizio === giornoFine) {
                    periodoText = `dalle ${formatTime(inizio)} alle ${formatTime(fine)} del ${formatDate(inizio)}`;
                } else {
                    periodoText = `dalle ${formatTime(inizio)} del ${formatDate(inizio)} alle ${formatTime(fine)} del ${formatDate(fine)}`;
                }

                if (now < inizio) {
                    statusText = 'Sciopero non iniziato';
                    statusColor = '#f39c12'; // Arancione
                    statusIcon = 'üïí';
                } else if (now > fine) {
                    statusText = 'Sciopero concluso';
                    statusColor = '#27ae60'; // Verde
                    statusIcon = '‚úÖ';
                } else {
                    statusText = 'Sciopero in Corso';
                    statusColor = '#e74c3c'; // Rosso
                    statusIcon = '‚ö†Ô∏è';
                }
            } else if (strikeInfo.descrizione && strikeInfo.descrizione !== 'Nessuno sciopero programmato') {
                // Se non ci sono date valide ma c'√® una descrizione di sciopero
                statusText = 'Sciopero in Corso';
                statusColor = '#e74c3c'; // Rosso
                statusIcon = '‚ö†Ô∏è';
            } else {
                statusText = 'Nessuno sciopero programmato';
                statusColor = '#34495e'; // Grigio scuro
                statusIcon = '‚ÑπÔ∏è';
            }

            // Aggiorna il titolo e lo stile della card
            strikeTitle.innerHTML = `${statusIcon} ${statusText}`;
            strikeCard.style.background = statusColor;
            strikeCard.style.boxShadow = `0 5px 15px ${statusColor}33`; // Ombra leggera

            strikeDetails.innerHTML = `
                <strong>${strikeInfo.descrizione || 'Nessuna descrizione'}</strong><br>
                <small>Periodo: ${periodoText}</small>
            `;
            strikeDiv.style.display = 'block';
        }
function displayStatistics(data) {
    // Usa la nuova struttura dati con nazionale e sicilia separati
    const stats = data.metadata.statistics;
    const nazionaleStats = stats.nazionale || {};
    const siciliaStats = stats.sicilia || {};

    // Usa solo i dati nazionali per le card statistiche
    const totalTreno = nazionaleStats.totali || 0;
    document.getElementById('total-trains').textContent = totalTreno;

    const totalGuaranteed = nazionaleStats.garantiti || 0;
    const totalSuppressed = nazionaleStats.soppressi || 0;
    const totalPartialSuppressed = nazionaleStats.parzialmente_soppressi || 0;
    const totalExecuted = nazionaleStats.effettuati || 0;
    const totalUngoverned = nazionaleStats.non_gestiti || 0;

    // Mostra e calcola percentuale principale
    displayMainPercentage(data);



    document.getElementById('garantiti').textContent = totalGuaranteed;
    document.getElementById('soppressi').textContent = totalSuppressed;
    document.getElementById('parzialmente-soppressi').textContent = totalPartialSuppressed;
    document.getElementById('effettuati').textContent = totalExecuted;
    document.getElementById('non-gestiti').textContent = totalUngoverned;

    // Nasconde le card con valore 0
    hideZeroCards({
        'garantiti': totalGuaranteed,
        'soppressi': totalSuppressed,
        'parzialmente-soppressi': totalPartialSuppressed,
        'effettuati': totalExecuted,
        'non-gestiti': totalUngoverned
    });

    // Crea il grafico di distribuzione degli stati
    displayDistributionChart(stats);
}

        function displayMainPercentage(data) {
            try {
                const stats = data.metadata.statistics;
                // Usa la nuova struttura dati con nazionale e sicilia separati
                const nazionaleStats = stats.nazionale || {};
                const siciliaStats = stats.sicilia || {};

                // Calcola totali solo per la sezione nazionale
                const totalTreno = nazionaleStats.totali || 0;
                const totalGuaranteed = nazionaleStats.garantiti || 0;
                const totalSuppressed = nazionaleStats.soppressi || 0;
                const totalPartialSuppressed = nazionaleStats.parzialmente_soppressi || 0;
                const totalUngoverned = nazionaleStats.non_gestiti || 0;
                const totalExecuted = nazionaleStats.effettuati || 0;

                const interessati = totalSuppressed + totalPartialSuppressed + totalUngoverned;
                const basePercentuale = totalExecuted + interessati;
                const percentualeMain = basePercentuale > 0 ? ((interessati / basePercentuale) * 100).toFixed(1) : 0;

                // Mostra sempre le card affiancate
                const topCardsDiv = document.getElementById('top-cards');
                const mainPercentageValue = document.getElementById('main-percentage-value');

                if (mainPercentageValue) {
                    mainPercentageValue.textContent = `${percentualeMain}%`;
                }
                if (topCardsDiv) {
                    topCardsDiv.style.display = 'flex';
                }
            } catch (error) {
                console.error('Errore nel calcolo percentuale:', error);
                // Mostra 0% in caso di errore
                const mainPercentageValue = document.getElementById('main-percentage-value');
                if (mainPercentageValue) {
                    mainPercentageValue.textContent = '0%';
                }
            }
        }

        function hideZeroCards(cardsData) {
            Object.keys(cardsData).forEach(cardId => {
                const value = cardsData[cardId];
                const cardElement = document.getElementById(cardId).closest('.stat-card');

                if (value === 0) {
                    cardElement.style.display = 'none';
                } else {
                    cardElement.style.display = 'block';
                }
            });
        }


        function displayDistributionChart(stats) {
            // Crea un nuovo container per il grafico di distribuzione se non esiste
            let distributionContainer = document.getElementById('distribution-chart');
            if (!distributionContainer) {
                const chartSection = document.createElement('div');
                chartSection.className = 'chart-container';
                chartSection.innerHTML = `
                    <h2 style="text-align: center; margin-bottom: 20px; color: #2c3e50; font-size: 1.6em;">üìä Distribuzione dei Treni Non Garantiti</h2>
                    <div id="distribution-chart" style="display: flex; justify-content: center; align-items: center; min-height: 280px;"></div>
                `;
                // Inserisci dopo le statistiche
                const statsGrid = document.querySelector('.stats-grid');
                if (statsGrid && statsGrid.parentNode) {
                    statsGrid.parentNode.insertBefore(chartSection, statsGrid.nextSibling);
                }
                distributionContainer = document.getElementById('distribution-chart');
            } else {
                console.log('Container grafico gi√† esistente'); // Debug
            }

            const nazionaleStats = stats.nazionale || {};
            const siciliaStats = stats.sicilia || {};

            // Calcola totale treni
            const totalTreno = (nazionaleStats.totali || 0) + (siciliaStats.totali || 0);

            // Somma i valori da nazionale e sicilia
            const totalGuaranteed = (nazionaleStats.garantiti || 0) + (siciliaStats.garantiti || 0);
            const totalSuppressed = (nazionaleStats.soppressi || 0) + (siciliaStats.soppressi || 0);
            const totalPartialSuppressed = (nazionaleStats.parzialmente_soppressi || 0) + (siciliaStats.parzialmente_soppressi || 0);
            const totalExecuted = (nazionaleStats.effettuati || 0) + (siciliaStats.effettuati || 0);
            const totalUngoverned = (nazionaleStats.non_gestiti || 0) + (siciliaStats.non_gestiti || 0);

            // Calcola totale treni non garantiti
            const totalNonGarantiti = totalTreno - totalGuaranteed;

            // Crea dati per il grafico a torta principale (solo treni non garantiti)
            const chartData = [
                { label: 'Effettuati', value: totalExecuted, color: '#27ae60', icon: '‚úÖ' },
                { label: 'Soppressi', value: totalSuppressed, color: '#e74c3c', icon: '‚ùå' },
                { label: 'Parzialmente Soppressi', value: totalPartialSuppressed, color: '#f39c12', icon: '‚ö†Ô∏è' },
                { label: 'Non Gestiti', value: totalUngoverned, color: '#9b59b6', icon: 'üìã' }
            ].filter(item => item.value > 0);

            if (chartData.length === 0) {
                distributionContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Nessun dato disponibile per il grafico di distribuzione</p>';
                return;
            }

            // Calcola il totale dalla somma effettiva dei valori nel grafico
            const total = chartData.reduce((sum, item) => sum + item.value, 0);

            if (total === 0) {
                distributionContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Totale treni non garantiti = 0 - nessun dato da visualizzare</p>';
                return;
            }

            // Crea il contenuto HTML
            const legendDiv = document.createElement('div');
            legendDiv.style.cssText = 'display: flex; flex-direction: column; gap: 12px;';

            chartData.forEach(item => {
                const percentage = ((item.value / total) * 100).toFixed(1);
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = `display: flex; align-items: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-height: 40px;`;

                // Container per icona e nome categoria (parte sinistra) con larghezza massima
                const leftContainer = document.createElement('div');
                leftContainer.style.cssText = 'display: flex; align-items: center; gap: 12px; max-width: 250px; flex: 1;';

                const colorDiv = document.createElement('div');
                colorDiv.style.cssText = `width: 20px; height: 20px; background: ${item.color}; border-radius: 50%; flex-shrink: 0;`;

                const labelSpan = document.createElement('span');
                labelSpan.style.cssText = 'font-weight: bold; color: #2c3e50; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
                labelSpan.textContent = `${item.icon} ${item.label}`;

                leftContainer.appendChild(colorDiv);
                leftContainer.appendChild(labelSpan);

                // Spazio fisso tra nome e percentuali
                const spacerDiv = document.createElement('div');
                spacerDiv.style.cssText = 'width: 15px; flex-shrink: 0;';

                // Percentuali (parte destra) - sempre allineate al bordo destro
                const valueSpan = document.createElement('span');
                valueSpan.style.cssText = `color: ${item.color}; font-weight: bold; white-space: nowrap; flex-shrink: 0;`;
                valueSpan.textContent = `${item.value} (${percentage}%)`;

                itemDiv.appendChild(leftContainer);
                itemDiv.appendChild(spacerDiv);
                itemDiv.appendChild(valueSpan);
                legendDiv.appendChild(itemDiv);
            });

            // Crea il grafico visuale (SVG) - ottimizzato per spazio
            const chartDiv = document.createElement('div');
            chartDiv.style.cssText = 'position: relative; width: 220px; height: 220px; margin: 0 auto;';

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '220');
            svg.setAttribute('height', '220');
            svg.setAttribute('viewBox', '0 0 220 220');

            // Cerchio di sfondo - ottimizzato per spazio
            const bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            bgCircle.setAttribute('cx', '110');
            bgCircle.setAttribute('cy', '110');
            bgCircle.setAttribute('r', '85');
            bgCircle.setAttribute('fill', 'none');
            bgCircle.setAttribute('stroke', '#ecf0f1');
            bgCircle.setAttribute('stroke-width', '20');
            svg.appendChild(bgCircle);

            // Segmenti del grafico - ottimizzato per spazio
            let currentAngle = 0;
            chartData.forEach((item, index) => {
                const percentage = item.value / total;
                const angle = percentage * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;

                const x1 = 110 + 85 * Math.cos((startAngle - 90) * Math.PI / 180);
                const y1 = 110 + 85 * Math.sin((startAngle - 90) * Math.PI / 180);
                const x2 = 110 + 85 * Math.cos((endAngle - 90) * Math.PI / 180);
                const y2 = 110 + 85 * Math.sin((endAngle - 90) * Math.PI / 180);

                const largeArcFlag = angle > 180 ? 1 : 0;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const pathData = `M 110 110 L ${x1} ${y1} A 85 85 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
                path.setAttribute('d', pathData);
                path.setAttribute('fill', item.color);
                path.setAttribute('stroke', 'white');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('title', `${item.label}: ${item.value} (${((item.value / total) * 100).toFixed(1)}%)`);

                svg.appendChild(path);
                currentAngle += angle;
            });

            chartDiv.appendChild(svg);

            // Testo centrale rimosso come richiesto

            // Container principale - responsive
            const mainContainer = document.createElement('div');

            // Verifica se siamo su mobile (larghezza schermo < 768px)
            const isMobile = window.innerWidth < 768;

            if (isMobile) {
                // Su mobile: grafico sopra, leggenda sotto - ottimizzato per spazio
                mainContainer.style.cssText = 'display: flex; flex-direction: column; gap: 20px; align-items: center; justify-content: center;';
                mainContainer.appendChild(chartDiv);
                mainContainer.appendChild(legendDiv);
            } else {
                // Su desktop: grafico e leggenda affiancati - ottimizzato per spazio
                mainContainer.style.cssText = 'display: grid; grid-template-columns: 280px 1fr; gap: 25px; align-items: center; justify-content: center;';
                mainContainer.appendChild(chartDiv);
                mainContainer.appendChild(legendDiv);
            }

            // Svuota e riempie il container
            distributionContainer.innerHTML = '';
            distributionContainer.appendChild(mainContainer);
        }


        function displayTrainsTable(trains) {
            const tbody = document.getElementById('trains-body');

            if (!trains || Object.keys(trains).length === 0) {
                tbody.innerHTML = '<div class="table-row" style="text-align: center; padding: 30px;">Nessun treno disponibile</div>';
                return;
            }

            // Crea l'header della tabella
            const headerDiv = document.createElement('div');
            headerDiv.className = 'table-row header';

            const headers = ['Categoria', 'Numero', 'Da', 'A', 'Orario', 'Stato', 'Regione'];
            headers.forEach(text => {
                const div = document.createElement('div');
                div.textContent = text;
                headerDiv.appendChild(div);
            });

            tbody.appendChild(headerDiv);

            // Crea le righe dei treni
            Object.values(trains).forEach(train => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'table-row';

                const trainData = [
                    train.category,
                    train.train_number,
                    train.from_station,
                    train.to_station,
                    train.departure_time,
                    train.status,
                    train.region
                ];

                trainData.forEach((data, index) => {
                    const div = document.createElement('div');
                    if (index === 5) { // Stato
                        const span = document.createElement('span');
                        span.className = `status ${train.status.replace(' ', '_').toLowerCase()}`;
                        span.textContent = data;
                        div.appendChild(span);
                    } else {
                        div.textContent = data;
                    }
                    rowDiv.appendChild(div);
                });

                tbody.appendChild(rowDiv);
            });
        }


        // Gestione errori di connessione
        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'SCRIPT' && e.target.src && e.target.src.includes('api/trains')) {
                document.getElementById('error').textContent =
                    'Impossibile connettersi al server. Verifica che l\'API sia in funzione.';
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        });
    </script>
</body>
</html>