<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Andamento scioperi treni - Sicilia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }

        .chart-label {
            min-width: 120px;
            font-weight: bold;
            color: #2c3e50;
        }

        .chart-track {
            flex: 1;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            margin: 0 15px;
            position: relative;
        }

        .chart-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease-in-out;
        }

        .chart-percentage {
            min-width: 50px;
            text-align: right;
            font-weight: bold;
            color: #2c3e50;
        }

        .impact-high { background: #e74c3c; }
        .impact-medium { background: #f39c12; }
        .impact-low { background: #27ae60; }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .last-update {
            background: #ecf0f1;
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #bdc3c7;
        }

        .strike-info {
            background: #e74c3c;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .strike-info h2 {
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .stats-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
            gap: 20px !important;
            padding: 20px !important;
            background: #f8f9fa !important;
            margin: 0 !important;
            margin-left: 20px !important;
            margin-right: 20px !important;
            box-sizing: border-box !important;
            width: auto !important;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .content {
            padding: 20px 0;
        }

        .sicilia-section {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .sicilia-section h3 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .comparison-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .comparison-card.national {
            border-left: 5px solid #3498db;
        }

        .comparison-card.sicilia {
            border-left: 5px solid #27ae60;
        }

        .comparison-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn.active,
        .filter-btn:hover {
            background: #3498db;
            color: white;
        }

        .trains-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .table-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            font-weight: bold;
            text-align: center;
        }

        .table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            padding: 15px 20px;
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.3s ease;
        }

        .table-row:hover {
            background: #f8f9fa;
        }

        .table-row.header {
            background: #34495e;
            color: white;
            font-weight: bold;
        }

        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
        }

        .status.partito {
            background: #27ae60;
            color: white;
        }

        .status.arrivato {
            background: #2980b9;
            color: white;
        }

        .status.soppresso {
            background: #e74c3c;
            color: white;
        }

        .status.parzialmente_soppresso {
            background: #f39c12;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 0.9em;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .tab-btn:hover {
            background: #2980b9 !important;
        }

        .tab-navigation {
            margin: 0 20px 30px 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            box-sizing: border-box;
        }

        .tab-btn {
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Chrome e altri browser */
            -webkit-touch-callout: none; /* Disabilita il menu di chiamata per iOS */
            margin: 0 !important; /* Sovrascrive inline styles */
            width: 100% !important; /* Forza larghezza corretta */
            border-radius: 8px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            transition: all 0.3s ease !important;
            cursor: pointer !important;
            border: 2px solid transparent !important;
            position: relative !important; /* Per posizionamento assoluto frecce */
        }

        /* Forza cursore pointer su tutti i tab buttons */
        .tab-btn-container .tab-btn {
            cursor: pointer !important;
        }

        .tab-btn-container:nth-child(1) .tab-btn,
        .tab-btn-container:nth-child(2) .tab-btn {
            cursor: pointer !important;
        }

        .tab-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25) !important;
            border: 2px solid rgba(255,255,255,0.3) !important;
        }

        .tab-btn.active {
            background: #3498db !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.4) !important;
        }

        /* Lenti decorative per suggerire interattivit√† */
        .tab-btn::after {
            content: "üîç";
            position: absolute !important;
            top: 8px !important;
            right: 8px !important;
            font-size: 0.8em !important;
            opacity: 0.9 !important;
            transition: all 0.3s ease !important;
            background: rgba(220, 220, 220, 0.9) !important;
            color: #2c3e50 !important;
            border: 1px solid rgba(44, 62, 80, 0.3) !important;
            border-radius: 4px !important;
            width: 20px !important;
            height: 20px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 1000 !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15) !important;
        }

        .tab-btn:hover::after {
            opacity: 1;
            transform: scale(1.2);
            background: rgba(200, 200, 200, 0.95) !important;
            color: #2c3e50 !important;
            border: 1px solid rgba(44, 62, 80, 0.4) !important;
        }

        .tab-btn * {
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Chrome e altri browser */
            -webkit-touch-callout: none; /* Disabilita il menu di chiamata per iOS */
        }

        .tab-btn-container {
            flex: 1 !important;
            margin: 0 !important;
            margin-left: 5px !important;
            margin-right: 5px !important;
            box-sizing: border-box !important;
        }

        .tab-percentage {
            font-size: 0.9em;
            font-weight: normal;
        }

        .modal {
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-btn:hover {
            color: #000 !important;
        }

        .tab-content {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .table-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }

            .filters {
                justify-content: center;
            }

            .top-cards {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÇ Andamento scioperi - Sicilia</h1>
            <div class="subtitle">Monitoraggio regionale Sicilia con confronto nazionale</div>
        </div>

        <!-- Card affiancate per sciopero e controlli -->
        <div id="top-cards" class="top-cards" style="display: none; display: flex; gap: 20px; margin: 20px auto; padding: 0 20px;">
            <div id="strike-info" class="strike-card" style="flex: 1; background: #e74c3c; color: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                <h2 style="margin-bottom: 15px; font-size: 1.3em;">‚ö†Ô∏è Sciopero in Corso</h2>
                <div id="strike-details" style="font-size: 0.95em; line-height: 1.4;"></div>
            </div>
            <div class="controls-card" style="flex: 1; background: #2c3e50; color: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                <div style="font-size: 1.1em; display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <div>
                        <div>üïê Ultimo aggiornamento:</div>
                        <div style="font-size: 1.2em; font-weight: bold;" id="last-update-display">Caricamento...</div>
                    </div>
                    <button class="refresh-btn" onclick="loadData()" style="background: #2980b9; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; font-size: 1.4em; white-space: nowrap; min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">üîÑ</button>
                </div>
            </div>
        </div>


        <div id="loading" class="loading">
            <h2>Caricamento dati...</h2>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">

            <!-- Tab Navigation -->
            <div class="tab-navigation" style="display: flex; margin-bottom: 30px; background: #f8f9fa; border-radius: 10px; padding: 10px; gap: 20px;">
                <div class="tab-btn-container">
                    <button class="tab-btn active" onclick="showModal('national')" onmousedown="return false" onselectstart="return false" oncontextmenu="return false" style="flex: 1; padding: 15px; border: none; background: #3498db; color: white; cursor: pointer; font-size: 1.1em; font-weight: bold; margin: 0; border-radius: 5px; transition: all 0.3s ease; width: 100%;">üìä Nazionale<br><span class="tab-percentage">impattati 0% dei treni</span></button>
                </div>
                <div class="tab-btn-container">
                    <button class="tab-btn" onclick="showModal('sicilia')" onmousedown="return false" onselectstart="return false" oncontextmenu="return false" style="flex: 1; padding: 15px; border: none; background: #95a5a6; color: white; cursor: pointer; font-size: 1.1em; font-weight: bold; margin: 0; border-radius: 5px; transition: all 0.3s ease; width: 100%;">üìä Sicilia<br><span class="tab-percentage">impattati 0% dei treni</span></button>
                </div>
            </div>

            <!-- Modal Nazionale -->
            <div id="national-modal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
                <div class="modal-content" style="background: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative;">
                    <span class="close-btn" onclick="closeModal('national')" style="position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa;">X</span>
                    <h3 style="text-align: center; margin-bottom: 10px; color: #3498db;">üìä Statistiche Nazionali Complete</h3>
                    <div style="text-align: center; margin-bottom: 20px; background: #e8f4fd; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 2.5em; font-weight: bold; color: #3498db;" id="national-impact-percentage">0%</div>
                        <div style="color: #7f8c8d; font-size: 0.9em;">dei treni non garantiti impattati</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="national-total-trains">0</div>
                            <div class="stat-label">Totale Treni</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="national-garantiti">0</div>
                            <div class="stat-label">Garantiti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="national-effettuati">0</div>
                            <div class="stat-label">Effettuati (non garantiti)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="national-soppressi">0</div>
                            <div class="stat-label">Soppressi (non garantiti)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="national-parzialmente-soppressi">0</div>
                            <div class="stat-label">Parzialmente Soppressi (non garantiti)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="national-non-gestiti">0</div>
                            <div class="stat-label">Programmati ma rimossi dai tabelloni</div>
                        </div>
                    </div>


                    <!-- Grafico impatto nazionale nel modal -->
                    <div class="chart-container">
                        <div id="national-modal-chart">
                            <!-- Il grafico sar√† generato dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Sicilia -->
            <div id="sicilia-modal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
                <div class="modal-content" style="background: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative;">
                    <span class="close-btn" onclick="closeModal('sicilia')" style="position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa;">X</span>
                    <h3 style="text-align: center; margin-bottom: 10px; color: #27ae60;">üìä Statistiche Sicilia Complete</h3>
                    <div style="text-align: center; margin-bottom: 20px; background: #e8f5e8; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 2.5em; font-weight: bold; color: #27ae60;" id="sicilia-impact-percentage">0%</div>
                        <div style="color: #7f8c8d; font-size: 0.9em;">dei treni non garantiti impattati</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="sicilia-total-trains">0</div>
                            <div class="stat-label">Totale Treni</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="sicilia-garantiti">0</div>
                            <div class="stat-label">Garantiti</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="sicilia-effettuati">0</div>
                            <div class="stat-label">Effettuati (non garantiti)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="sicilia-soppressi">0</div>
                            <div class="stat-label">Soppressi (non garantiti)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="sicilia-parzialmente-soppressi">0</div>
                            <div class="stat-label">Parzialmente Soppressi (non garantiti)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="sicilia-non-gestiti">0</div>
                            <div class="stat-label">Programmati ma rimossi dai tabelloni</div>
                        </div>
                    </div>


                    <!-- Grafico impatto Sicilia nel modal -->
                    <div class="chart-container">
                        <div id="sicilia-modal-chart">
                            <!-- Il grafico sar√† generato dinamicamente -->
                        </div>
                    </div>

                </div>
            </div>



            <div class="trains-table" id="trains-table-container" style="display: none;">
                <div class="table-header">Treni partiti che non sono da garantire</div>
                <div id="trains-body">
                    <!-- I dati saranno inseriti dinamicamente -->
                </div>
            </div>

            <!-- Messaggio quando non ci sono treni -->
            <div id="no-trains-message" class="no-trains-message" style="display: block !important; text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px; margin: 30px auto; max-width: 600px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 2px solid #dee2e6; position: relative; z-index: 100;">
                <div style="font-size: 1.2em; color: #495057; margin-bottom: 10px;">üöÇ Situazione Sicilia</div>
                <div style="font-size: 1.1em; color: #6c757d; font-weight: 500;">Nessun treno non garantito √® partito fino ad ora</div>
            </div>
        </div>
    </div>

    <script>
        // Configurazione
        const API_BASE = 'https://mansellrace.synology.me:10101';
        let trainsData = {};
        let currentFilter = 'all';
        let refreshInterval;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            // Auto-refresh ogni minuto (o intervallo specificato dall'API)
            setInterval(loadData, 60000);
        });

        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('content').style.display = 'none';
                document.getElementById('error').style.display = 'none';

                const response = await fetch(`${API_BASE}/api/trains`);

                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }

                trainsData = await response.json();

                // Verifica se i dati sono validi
                if (!trainsData || !trainsData.metadata) {
                    throw new Error('Dati ricevuti non validi');
                }

                displayData(trainsData);

            } catch (error) {
                console.error('Errore nel caricamento dati:', error);

                // Mostra errore solo se √® un vero errore di connessione
                if (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('HTTPS')) {
                    document.getElementById('error').textContent =
                        'Errore di connessione. Verifica che l\'API sia in funzione.';
                    document.getElementById('error').style.display = 'block';
                } else {
                    // Se l'API funziona ma i dati sono vuoti, mostra comunque la pagina
                    console.log('API funziona ma dati vuoti, mostro pagina con valori 0');
                    displayData(trainsData || { metadata: { statistics: { total_trains: 0, by_category: {} }, strike_info: { descrizione: 'Nessuno sciopero programmato' } }, trains: {} });
                }

                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayData(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // Aggiorna timestamp nella card
            if (data.metadata.last_updated) {
                const lastUpdate = new Date(data.metadata.last_updated);
                if (!isNaN(lastUpdate.getTime())) {
                    document.getElementById('last-update-display').textContent =
                        lastUpdate.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                } else {
                    document.getElementById('last-update-display').textContent = 'Data non valida';
                }
            } else {
                document.getElementById('last-update-display').textContent = 'Mai aggiornato';
            }

            // Info sciopero
            displayStrikeInfo(data.metadata.strike_info);

            // La funzione displayMainPercentage √® stata rimossa, quindi non la chiamiamo pi√π.
            // displayMainPercentage(data);

            // Calcola e aggiorna percentuali nei pulsanti
            updateTabButtons(data);

            // Mostra le card affiancate
            document.getElementById('top-cards').style.display = 'flex';

            // Imposta intervallo di refresh dall'API
            if (data.metadata.refresh_interval) {
                clearInterval(refreshInterval);
                refreshInterval = setInterval(loadData,
                    data.metadata.refresh_interval * 1000);
            }
        }

        function displayStrikeInfo(strikeInfo) {
            const strikeDiv = document.getElementById('strike-info');
            const strikeDetails = document.getElementById('strike-details');
            const strikeCard = strikeDiv.closest('.strike-card'); // Ottieni la card esterna
            const strikeTitle = strikeCard.querySelector('h2'); // Ottieni il titolo

            const now = new Date();
            const inizio = strikeInfo.inizio ? new Date(strikeInfo.inizio) : null;
            const fine = strikeInfo.fine ? new Date(strikeInfo.fine) : null;

            let statusText = '';
            let statusColor = '';
            let statusIcon = '';
            let periodoText = 'Non specificato';

            // Formatta date in italiano
            const formatTime = (date) => date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            const formatDate = (date) => date.toLocaleDateString('it-IT', { day: 'numeric', month: 'numeric' });

            if (inizio && fine) {
                const giornoInizio = inizio.toDateString();
                const giornoFine = fine.toDateString();

                if (giornoInizio === giornoFine) {
                    periodoText = `dalle ${formatTime(inizio)} alle ${formatTime(fine)} del ${formatDate(inizio)}`;
                } else {
                    periodoText = `dalle ${formatTime(inizio)} del ${formatDate(inizio)} alle ${formatTime(fine)} del ${formatDate(fine)}`;
                }

                if (now < inizio) {
                    statusText = 'Sciopero non iniziato';
                    statusColor = '#f39c12'; // Arancione
                    statusIcon = 'üïí';
                } else if (now > fine) {
                    statusText = 'Sciopero concluso';
                    statusColor = '#27ae60'; // Verde
                    statusIcon = '‚úÖ';
                } else {
                    statusText = 'Sciopero in Corso';
                    statusColor = '#e74c3c'; // Rosso
                    statusIcon = '‚ö†Ô∏è';
                }
            } else if (strikeInfo.descrizione && strikeInfo.descrizione !== 'Nessuno sciopero programmato') {
                // Se non ci sono date valide ma c'√® una descrizione di sciopero
                statusText = 'Sciopero in Corso';
                statusColor = '#e74c3c'; // Rosso
                statusIcon = '‚ö†Ô∏è';
            } else {
                statusText = 'Nessuno sciopero programmato';
                statusColor = '#34495e'; // Grigio scuro
                statusIcon = '‚ÑπÔ∏è';
            }

            // Aggiorna il titolo e lo stile della card
            strikeTitle.innerHTML = `${statusIcon} ${statusText}`;
            strikeCard.style.background = statusColor;
            strikeCard.style.boxShadow = `0 5px 15px ${statusColor}33`; // Ombra leggera

            strikeDetails.innerHTML = `
                <strong>${strikeInfo.descrizione || 'Nessuna descrizione'}</strong><br>
                <small>Periodo: ${periodoText}</small>
            `;
            strikeDiv.style.display = 'block';
        }


        function updateTabButtons(data) {
            const stats = data.metadata.statistics;

            // Usa la nuova struttura dati con nazionale e sicilia separati
            const nazionaleStats = stats.nazionale || {};
            const siciliaStats = stats.sicilia || {};

            // Calcola % impatto nazionale (rispetto ai non garantiti)
            const totalTrenoNazionale = nazionaleStats.totali || 0;
            const totalGuaranteedNazionale = nazionaleStats.garantiti || 0;
            const totalSuppressedNazionale = nazionaleStats.soppressi || 0;
            const totalPartialSuppressedNazionale = nazionaleStats.parzialmente_soppressi || 0;
            const totalExecutedNazionale = nazionaleStats.effettuati || 0; // Definita qui
            const totalUngovernedNazionale = nazionaleStats.non_gestiti || 0;

            const interessatiNazionale = totalSuppressedNazionale + totalPartialSuppressedNazionale + totalUngovernedNazionale;
            const basePercentualeNazionale = totalExecutedNazionale + interessatiNazionale;
            const percentualeNazionale = basePercentualeNazionale > 0 ? ((interessatiNazionale / basePercentualeNazionale) * 100).toFixed(1) : 0;

            // Calcola % impatto Sicilia (rispetto ai non garantiti Sicilia)
            const totalTrenoSicilia = siciliaStats.totali || 0;
            const totalGuaranteedSicilia = siciliaStats.garantiti || 0;
            const totalSuppressedSicilia = siciliaStats.soppressi || 0;
            const totalPartialSuppressedSicilia = siciliaStats.parzialmente_soppressi || 0;
            const totalExecutedSicilia = siciliaStats.effettuati || 0;
            const totalUngovernedSicilia = siciliaStats.non_gestiti || 0;

            const interessatiSicilia = totalSuppressedSicilia + totalPartialSuppressedSicilia + totalUngovernedSicilia;
            const basePercentualeSicilia = totalExecutedSicilia + interessatiSicilia;
            const percentualeSicilia = basePercentualeSicilia > 0 ? ((interessatiSicilia / basePercentualeSicilia) * 100).toFixed(1) : 0;

            // Aggiorna pulsanti con percentuali
            const nationalPercentageSpan = document.querySelector('.tab-btn-container:nth-child(1) .tab-percentage');
            const siciliaPercentageSpan = document.querySelector('.tab-btn-container:nth-child(2) .tab-percentage');

            if (nationalPercentageSpan) {
                nationalPercentageSpan.innerHTML = `impattati <span style="font-size: 1.2em; font-weight: bold;">${percentualeNazionale}%</span> dei treni`;
            }
            if (siciliaPercentageSpan) {
                siciliaPercentageSpan.innerHTML = `impattati <span style="font-size: 1.2em; font-weight: bold;">${percentualeSicilia}%</span> dei treni`;
            }
        }

        function showModal(modalType) {
            // Deseleziona qualsiasi testo selezionato
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            } else if (document.selection) {
                document.selection.empty();
            }

            // Chiudi tutti i modal aperti
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
            });

            // Rimuovi classe active da tutti i bottoni
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#95a5a6';
            });

            // Mostra il modal selezionato
            document.getElementById(`${modalType}-modal`).style.display = 'block';

            // Evidenzia il bottone attivo
            const activeBtn = event.target.closest('.tab-btn');
            activeBtn.classList.add('active');
            activeBtn.style.background = '#3498db';

            // Carica i dati per il modal selezionato
            loadModalData(modalType);

            // Deseleziona di nuovo dopo un breve delay per sicurezza
            setTimeout(() => {
                if (window.getSelection) {
                    window.getSelection().removeAllRanges();
                } else if (document.selection) {
                    document.selection.empty();
                }
                // Rimuovi focus dal pulsante
                if (document.activeElement && document.activeElement.blur) {
                    document.activeElement.blur();
                }
            }, 10);
        }

        function closeModal(modalType) {
            document.getElementById(`${modalType}-modal`).style.display = 'none';

            // Rimuovi classe active dal bottone
            const btnContainers = document.querySelectorAll('.tab-btn-container');
            btnContainers.forEach(container => {
                const btn = container.querySelector('.tab-btn');
                btn.classList.remove('active');
                btn.style.background = '#95a5a6';
            });
        }

        function loadModalData(modalType) {
            if (modalType === 'national') {
                displayNationalModal();
            } else if (modalType === 'sicilia') {
                displaySiciliaModal();
            }
        }

        function displayNationalModal() {
            const stats = trainsData.metadata.statistics;
            const nazionaleStats = stats.nazionale || {};

            const totalTreno = nazionaleStats.totali || 0;
            document.getElementById('national-total-trains').textContent = totalTreno;

            // Usa i valori diretti dalla nuova struttura
            const totalGuaranteed = nazionaleStats.garantiti || 0;
            const totalSuppressed = nazionaleStats.soppressi || 0;
            const totalPartialSuppressed = nazionaleStats.parzialmente_soppressi || 0;
            const totalExecuted = nazionaleStats.effettuati || 0;
            const totalUngoverned = nazionaleStats.non_gestiti || 0;

            // ASSEGNA I VALORI AGLI ELEMENTI HTML
            document.getElementById('national-garantiti').textContent = totalGuaranteed;
            document.getElementById('national-effettuati').textContent = totalExecuted;
            document.getElementById('national-soppressi').textContent = totalSuppressed;
            document.getElementById('national-parzialmente-soppressi').textContent = totalPartialSuppressed;
            document.getElementById('national-non-gestiti').textContent = totalUngoverned;

            // Nasconde le card con valore 0
            hideZeroCards('national', {
                'national-garantiti': totalGuaranteed,
                'national-soppressi': totalSuppressed,
                'national-parzialmente-soppressi': totalPartialSuppressed,
                'national-effettuati': totalExecuted,
                'national-non-gestiti': totalUngoverned
            });

            // Calcolo % impatto nazionale (treni interessati vs effettuati + interessati)
            const interessati = totalSuppressed + totalPartialSuppressed + totalUngoverned;
            const basePercentuale = totalExecuted + interessati;
            const percentualeImpatto = basePercentuale > 0 ? ((interessati / basePercentuale) * 100).toFixed(1) : 0;

            document.getElementById('national-impact-percentage').textContent = `${percentualeImpatto}%`;

            // Crea il grafico a torta per la distribuzione stati nazionale nel modal
            displayModalDistributionChart('national-modal-chart', nazionaleStats, 'Nazionale');
        }

        function displaySiciliaModal() {
            const stats = trainsData.metadata.statistics;
            const siciliaStats = stats.sicilia || {};

            // Usa i valori diretti dalla nuova struttura
            const totalTrenoSicilia = siciliaStats.totali || 0;
            document.getElementById('sicilia-total-trains').textContent = totalTrenoSicilia;

            // Usa i valori diretti dalla nuova struttura
            const garantitiSicilia = siciliaStats.garantiti || 0;
            const soppressiSicilia = siciliaStats.soppressi || 0;
            const parzialmenteSoppressiSicilia = siciliaStats.parzialmente_soppressi || 0;
            const effettuatiSicilia = siciliaStats.effettuati || 0;
            const nonGestitiSicilia = siciliaStats.non_gestiti || 0;

            // ASSEGNA I VALORI AGLI ELEMENTI HTML
            document.getElementById('sicilia-garantiti').textContent = garantitiSicilia;
            document.getElementById('sicilia-effettuati').textContent = effettuatiSicilia;
            document.getElementById('sicilia-soppressi').textContent = soppressiSicilia;
            document.getElementById('sicilia-parzialmente-soppressi').textContent = parzialmenteSoppressiSicilia;
            document.getElementById('sicilia-non-gestiti').textContent = nonGestitiSicilia;

            // Nasconde le card con valore 0
            hideZeroCards('sicilia', {
                'sicilia-garantiti': garantitiSicilia,
                'sicilia-soppressi': soppressiSicilia,
                'sicilia-parzialmente-soppressi': parzialmenteSoppressiSicilia,
                'sicilia-effettuati': effettuatiSicilia,
                'sicilia-non-gestiti': nonGestitiSicilia
            });

            // Calcolo % impatto Sicilia (treni interessati vs non garantiti Sicilia)
            const interessatiSicilia = soppressiSicilia + parzialmenteSoppressiSicilia + nonGestitiSicilia;
            const basePercentualeSicilia = effettuatiSicilia + interessatiSicilia;
            const percentualeImpattoSicilia = basePercentualeSicilia > 0 ? ((interessatiSicilia / basePercentualeSicilia) * 100).toFixed(1) : 0;

            document.getElementById('sicilia-impact-percentage').textContent = `${percentualeImpattoSicilia}%`;

            // Crea il grafico a torta per la distribuzione stati Sicilia nel modal
            displayModalDistributionChart('sicilia-modal-chart', siciliaStats, 'Sicilia');

            // La tabella dei treni Sicilia nel modal √® stata rimossa come richiesto.
            // displaySiciliaTrainsTableInModal(trainsData.trains);
        }

        function hideZeroCards(modalType, cardsData) {
            Object.keys(cardsData).forEach(cardId => {
                const value = cardsData[cardId];
                const cardElement = document.getElementById(cardId).closest('.stat-card');

                if (value === 0) {
                    cardElement.style.display = 'none';
                } else {
                    cardElement.style.display = 'block';
                }
            });
        }

        function displayModalImpactChart(containerId, totalTreno, interessati, percentuale, region) {
            // Questa funzione non √® pi√π necessaria per il grafico a barre,
            // ma la lascio per evitare errori se fosse ancora chiamata altrove.
            // Il grafico a torta √® gestito da displayModalDistributionChart.
            const chartContainer = document.getElementById(containerId);
            chartContainer.innerHTML = ''; // Pulisci il contenuto per evitare duplicati
        }

        function displaySiciliaTrainsTableInModal(trains) {
            const tbody = document.getElementById('sicilia-trains-body');

            // Filtra solo treni della Sicilia
            const siciliaTreno = Object.values(trains).filter(train => train.region === 'Sicilia');

            if (!siciliaTreno || siciliaTreno.length === 0) {
                tbody.innerHTML = '<div class="table-row" style="text-align: center; padding: 30px;">Nessun treno disponibile per la Sicilia</div>';
                return;
            }

            let html = `
                <div class="table-row header">
                    <div>Categoria</div>
                    <div>Numero</div>
                    <div>Da</div>
                    <div>A</div>
                    <div>Orario</div>
                    <div>Stato</div>
                    <div>Regione</div>
                </div>
            `;

            siciliaTreno.forEach(train => {
                html += `
                    <div class="table-row">
                        <div>${train.category}</div>
                        <div>${train.train_number}</div>
                        <div>${train.from_station}</div>
                        <div>${train.to_station}</div>
                        <div>${train.departure_time}</div>
                        <div><span class="status ${train.status.replace(' ', '_').toLowerCase()}">${train.status}</span></div>
                        <div>${train.region}</div>
                    </div>
                `;
            });

            tbody.innerHTML = html;
        }

        function displaySiciliaTrainsTable(trains) {
            const tableContainer = document.getElementById('trains-table-container');
            const tbody = document.getElementById('trains-body');
            const noTrainsMessage = document.getElementById('no-trains-message');

            // Filtra solo treni della Sicilia
            const siciliaTreno = Object.values(trains).filter(train => train.region === 'Sicilia');

            // Conta solo i treni non garantiti (quelli che potrebbero essere soggetti a sciopero)
            const nonGarantitiPartiti = siciliaTreno.filter(train =>
                train.status === 'partito' || train.status === 'arrivato'
            );

            if (!nonGarantitiPartiti || nonGarantitiPartiti.length === 0) {
                // Nascondi tabella e mostra messaggio
                tableContainer.style.display = 'none';
                noTrainsMessage.style.display = 'block !important';
                console.log('Mostrando messaggio - nessun treno non garantito partito');
                return;
            }

            // Mostra tabella e nasconde messaggio
            tableContainer.style.display = 'block';
            noTrainsMessage.style.display = 'none';
            console.log('Mostrando tabella - ci sono ' + nonGarantitiPartiti.length + ' treni non garantiti partiti');

            let html = `
                <div class="table-row header">
                    <div>Categoria</div>
                    <div>Numero</div>
                    <div>Da</div>
                    <div>A</div>
                    <div>Orario</div>
                    <div>Stato</div>
                    <div>Regione</div>
                </div>
            `;

            siciliaTreno.forEach(train => {
                html += `
                    <div class="table-row">
                        <div>${train.category}</div>
                        <div>${train.train_number}</div>
                        <div>${train.from_station}</div>
                        <div>${train.to_station}</div>
                        <div>${train.departure_time}</div>
                        <div><span class="status ${train.status.replace(' ', '_').toLowerCase()}">${train.status}</span></div>
                        <div>${train.region}</div>
                    </div>
                `;
            });

            tbody.innerHTML = html;
        }

        function displayModalDistributionChart(containerId, regionStats, regionName) {
            const chartContainer = document.getElementById(containerId);
            chartContainer.innerHTML = ''; // Pulisci il contenuto precedente

            // Crea dati per il grafico a torta della regione specifica, escludendo i "Garantiti"
            const chartData = [
                { label: 'Effettuati', value: regionStats.effettuati || 0, color: '#27ae60', icon: '‚úÖ' },
                { label: 'Soppressi', value: regionStats.soppressi || 0, color: '#e74c3c', icon: '‚ùå' },
                { label: 'Parzialmente Soppressi', value: regionStats.parzialmente_soppressi || 0, color: '#f39c12', icon: '‚ö†Ô∏è' },
                { label: 'Non Gestiti', value: regionStats.non_gestiti || 0, color: '#9b59b6', icon: 'üìã' }
            ].filter(item => item.value > 0);

            if (chartData.length === 0) {
                chartContainer.innerHTML += '<p style="text-align: center; color: #7f8c8d; margin-top: 20px;">Nessun dato disponibile per il grafico di distribuzione</p>';
                return;
            }

            const total = chartData.reduce((sum, item) => sum + item.value, 0);

            // Contenitore principale per il grafico e la legenda
            const mainChartWrapper = document.createElement('div');
            mainChartWrapper.style.cssText = 'display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-start; gap: 20px; margin-top: 20px;';

            // Crea il contenitore per il grafico visuale (SVG)
            const chartDiv = document.createElement('div');
            chartDiv.style.cssText = 'position: relative; width: 200px; height: 200px; flex-shrink: 0;';

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '200');
            svg.setAttribute('height', '200');
            svg.setAttribute('viewBox', '0 0 200 200');

            // Cerchio di sfondo
            const bgCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            bgCircle.setAttribute('cx', '100');
            bgCircle.setAttribute('cy', '100');
            bgCircle.setAttribute('r', '80');
            bgCircle.setAttribute('fill', 'none');
            bgCircle.setAttribute('stroke', '#ecf0f1');
            bgCircle.setAttribute('stroke-width', '20');
            svg.appendChild(bgCircle);

            // Segmenti del grafico
            let currentAngle = 0;
            chartData.forEach((item) => {
                const percentage = item.value / total;
                const angle = percentage * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;

                const x1 = 100 + 80 * Math.cos((startAngle - 90) * Math.PI / 180);
                const y1 = 100 + 80 * Math.sin((startAngle - 90) * Math.PI / 180);
                const x2 = 100 + 80 * Math.cos((endAngle - 90) * Math.PI / 180);
                const y2 = 100 + 80 * Math.sin((endAngle - 90) * Math.PI / 180);

                const largeArcFlag = angle > 180 ? 1 : 0;

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const pathData = `M 100 100 L ${x1} ${y1} A 80 80 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
                path.setAttribute('d', pathData);
                path.setAttribute('fill', item.color);
                path.setAttribute('stroke', 'white');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('title', `${item.label}: ${item.value} (${((item.value / total) * 100).toFixed(1)}%)`);

                svg.appendChild(path);
                currentAngle += angle;
            });

            chartDiv.appendChild(svg);

            // Centro del grafico con totale (rimosso come richiesto)
            // const centerDiv = document.createElement('div');
            // centerDiv.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;';

            // const totalDiv = document.createElement('div');
            // totalDiv.style.cssText = 'font-size: 1.8em; font-weight: bold; color: #2c3e50;';
            // totalDiv.textContent = total;

            // const totalLabelDiv = document.createElement('div');
            // totalLabelDiv.style.cssText = 'font-size: 0.8em; color: #7f8c8d;';
            // totalLabelDiv.textContent = 'Totale';

            // centerDiv.appendChild(totalDiv);
            // centerDiv.appendChild(totalLabelDiv);
            // chartDiv.appendChild(centerDiv);

            // Crea il contenuto HTML per la legenda
            const legendDiv = document.createElement('div');
            legendDiv.style.cssText = 'display: flex; flex-direction: column; gap: 8px; flex-grow: 1; min-width: 200px;';

            chartData.forEach(item => {
                const percentage = ((item.value / total) * 100).toFixed(1);
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);';

                const colorDiv = document.createElement('div');
                colorDiv.style.cssText = `width: 20px; height: 20px; background: ${item.color}; border-radius: 50%; flex-shrink: 0;`;

                const labelSpan = document.createElement('span');
                labelSpan.style.cssText = 'font-weight: bold; color: #2c3e50; font-size: 1em; flex-grow: 1;';
                labelSpan.textContent = `${item.icon} ${item.label}`;

                const valueSpan = document.createElement('span');
                valueSpan.style.cssText = `color: ${item.color}; font-weight: bold; font-size: 1em; flex-shrink: 0;`;
                valueSpan.textContent = `${item.value} (${percentage}%)`;

                itemDiv.appendChild(colorDiv);
                itemDiv.appendChild(labelSpan);
                itemDiv.appendChild(valueSpan);
                legendDiv.appendChild(itemDiv);
            });

            // Aggiungi titolo al grafico
            const titleElement = document.createElement('h4');
            titleElement.style.cssText = 'text-align: center; margin-bottom: 20px; color: #2c3e50; width: 100%;';
            titleElement.textContent = 'üìä Distribuzione dei Treni Non Garantiti';

            chartContainer.appendChild(titleElement);
            mainChartWrapper.appendChild(chartDiv);
            mainChartWrapper.appendChild(legendDiv);
            chartContainer.appendChild(mainChartWrapper);
        }

        // Gestione errori di connessione
        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'SCRIPT' && e.target.src && e.target.src.includes('api/trains')) {
                document.getElementById('error').textContent =
                    'Impossibile connettersi al server. Verifica che l\'API sia in funzione.';
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        });
    </script>
</body>
</html>
